<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Localpost - Messages</title>
  <link rel="stylesheet" href="static/style.css">
  <link rel="shortcut icon" href="/static/favicon.png" type="image/x-icon">
</head>
<body>
  <header class="header">
    <nav class="width-keeper">
      <div class="logo">localpost:</div>
    </nav>

  </header>
  <main class="main">
    <div class="d-flex justify-center">  
    <article class="width-keeper">
      <div class="messages">
        {% for msg in messages %}
        <div class="message">
          <div class="head">
            <span style="color: {{msg.sender.color}}" title="{{msg.sender.name}}">{{ msg.sender.acronym }}</span>
            -&#62; [
            {% for rep in msg.recipients %}
            <span style="color: {{rep.color}}" title="{{ rep.name }}">{{ rep.acronym }}</span>
            {% endfor %}
            ]
            <div class="time">{{ msg.time }}</div>
          </div>
          <div class="text">
            {{ msg.text }}
          </div>
        </div>
        {% endfor %}
      </div>
    </article>
    </div>
  </main>
  <footer class="d-flex justify-center footer">
    <div class="width-keeper">
      <form action="" method="post" autocomplete="off" id="form" class="sender">
        <div class="d-flex mb-1">
          <textarea form="form" name="text" rows="1" cols="50" required></textarea>
          <input type="submit" value="Send" class="button">
        </div>
        <div class="d-flex no-h-scroll">
          <div class="popup-container">
            <input class="popup-trigger" id="trigger" type="checkbox"/>
            <div class="popup-itself">
              {% for u in users %}
              <div class="select-recipient">
                <input type="checkbox" id="usr{{u.id}}" class="recipient-checkbox" name="usr{{u.id}}"/>&nbsp;
                <label for="usr{{u.id}}">
                  [<span class="acronym" style="color: {{u.color}}">{{ u.acronym }}</span>] {{ u.name }}
                </label>
              </div>
              {% endfor %}
            </div>
            <label for="trigger" class="button popup-label" >
              Recepients:
            </label>
          </div>
          <div id="form-status-bar" class="ellipsis" style="color: silver">
            &#60;noscript/&#62;
          </div>
        </div>
      </form>
    </div>
  </footer>
  <script>


    const form = document.querySelector("form.sender");
    const statusbar = document.getElementById("form-status-bar");
    const submit = document.querySelector("form.sender input[type=submit]");
    const r_checks = Array.from(document.querySelectorAll("form.sender input[type=checkbox].recipient-checkbox"));
    const comma = document.createTextNode(",");
    const bracket = document.createTextNode("]");

    statusbar.style.color = "darkslategrey";
    statusbar.textContent = "rendering...";

    let r_arr_marks = {};

    const onCheckClick = (e) => {
      if (e.target.checked) {
        if ( statusbar.textContent == "> no recipients") statusbar.textContent = "> [";

        let label = r_arr_marks[e.target.id];
        if (!label) {
          const acronyms = e.target.parentElement.getElementsByClassName("acronym");
          if (acronyms.length > 0) {
            label = acronyms[0].cloneNode(true);
            r_arr_marks[e.target.id] = label;
          }
        }
        if (statusbar.contains(bracket)) statusbar.removeChild(bracket);
        if (statusbar.lastChild.nodeType != 3) {
          last_comma = comma.cloneNode(true);
          statusbar.appendChild(last_comma);
        }
        statusbar.appendChild(label);
        statusbar.appendChild(bracket);
      } else {
        let label = r_arr_marks[e.target.id];
        let prev = label.previousSibling;
        let next = label.nextSibling;
        if (statusbar.contains(label)) statusbar.removeChild(label);
        if (prev && prev.textContent == ",") statusbar.removeChild(prev);
        else {
          if (next && next.textContent == ",") statusbar.removeChild(next);
        }

      }
    };


    const renderStatusBar = (e) => {
      let is_empty = true;
      statusbar.textContent = "> [";

      let last_comma = null;
      for (let i = 0; i < r_checks.length; i++) {
        let each = r_checks[i];
        if (each.checked) {
          is_empty = false;
          let label = r_arr_marks[each.id];
          if (!label) {
            const acronyms = each.parentElement.getElementsByClassName("acronym");
            if (acronyms.length > 0) {
              label = acronyms[0].cloneNode(true);
              r_arr_marks[each.id] = label;
            }
          }
          statusbar.appendChild(label);
          last_comma = comma.cloneNode(true);
          comma_stack.push(last_comma);
          statusbar.appendChild(last_comma);
        }
      }
      if (is_empty) {
        statusbar.textContent = "> no recipients";
      } else {
        statusbar.removeChild(last_comma)  
        statusbar.appendChild(bracket);
      }
    };

    r_checks.forEach(a => a.addEventListener("change", onCheckClick));
    renderStatusBar();

    
  </script>



</body>
</html>
